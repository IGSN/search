#if($response.facetFields)
  #set($cur_fqs = $request.params.getParams('fq'))
  #set($limit_glob = $request.params.toNamedList().get("facet.limit"))
  #foreach($field in $response.facetFields)
    #set($limit_local = 0)
    #set($limit_local = $request.params.toNamedList().get("f.${field.name}.facet.limit"))
    #set($limit = $math.max($limit_glob,$limit_local))
    #set($count = $field.values.size())
    #if($count > 0)
    <div class="facet" id="facet-$field.name">     
      <h3>#normalize_facet($field.name)</h3>
      <div class="facet_data">
        <ul>
        #foreach($facet in $field.values)
          #if($velocityCount == $limit)#break#end
          #set($fq = "$esc.url($field.name):$esc.getQ()$esc.url($facet.name)$esc.getQ()")
          #set($fq_applied = false)
          #foreach($cur_fq in $cur_fqs)
            #if($fq == $cur_fq)
              #set($fq_applied = true)
              #break
            #end
          #end
          #if(!$fq_applied) 
            <li><a href="#url_for_facet_filter($field.name, $facet.name)"><span class="value">$facet.name</span> <span class="count">($facet.count)</span></a></li>
          #end
        #end
        </ul>

      #if($count == $limit)
        #set($new_limit = $math.add($limit,5))
        <a class="more" href="#url_for_show_more_facet($field.name,$new_limit)">more</a>
      #end 
      </div>
    </div>
    #end
  #end
#end