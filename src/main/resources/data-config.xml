<dataConfig>
  <dataSource name="db" type="JdbcDataSource" driver="com.mysql.jdbc.Driver"
    url="${dataimporter.request.db.url}" user="${dataimporter.request.db.user}" password="${dataimporter.request.db.password}" readonly="true"
    batchSize="-1" />
    <!-- for batchSize=-1 see DIH FAQ -->
  <dataSource name="field" type="FieldReaderDataSource" />
  <document>
    <!-- SOLR-2104 -->
    <entity name="dataset" dataSource="db"
      query="SELECT d.doi AS doi,
                    d.id AS dataset_id,
                    dc.symbol AS datacentre_symbol,
                    CONCAT(dc.symbol, ' - ', dc.name) AS datacentre,
                    al.symbol AS allocator_symbol,
                    CONCAT(al.symbol, ' - ', al.name) AS allocator,
                    m.xml,
                    m.created AS uploaded,
                    m.namespace,
                    d.is_ref_quality AS refQuality,
                    if(d.is_active,null,'true') AS $skipDoc,
                    if(d.is_active,null,d.doi) AS $deleteDocById
             FROM dataset AS d
             LEFT JOIN metadata AS m
               ON m.dataset = d.id
                 AND m.metadata_version =
                     (SELECT MAX(metadata_version) AS max_version
                      FROM metadata AS mm
                      WHERE mm.dataset = d.id)
             LEFT JOIN media AS mt ON mt.dataset = d.id
             JOIN datacentre AS dc ON d.datacentre = dc.id
             JOIN allocator AS al ON dc.allocator = al.id
             WHERE d.doi not like '${dataimporter.request.testprefix}/%'
               AND ( '${dataimporter.request.clean}' != 'false'
                     OR GREATEST(m.created, d.updated, mt.updated) > '${dataimporter.last_index_time}' )
             GROUP BY dataset_id
            "
      transformer="RegexTransformer">
      <!-- 
        using delta import as proposed in
        http://wiki.apache.org/solr/DataImportHandlerDeltaQueryViaFullImport
       -->
      <field column="prefix" regex="([^/]*)/" sourceColName="doi"/>
      <field column="schema_version" regex="-(\d+(.\d+)*)$" sourceColName="namespace"/>
       
      <entity name="xml" dataSource="field" dataField="dataset.xml"
        forEach="/resource" processor="XPathEntityProcessor" onError="skip"
        transformer="org.datacite.search.handler.dataimport.KeyValueTransformer">
        <field column="title" xpath="//title" />
        <field column="creator" xpath="//creatorName" />
        <field column="publisher" xpath="//publisher" />
        <field column="publicationYear" xpath="//publicationYear" />
        <field column="subject" xpath="//subject" />
        <field column="contributor" xpath="//contributorName" />
        <field column="date" xpath="//date" />
        <field column="language" xpath="//language" />
        <field column="resourceTypeGeneral" xpath="//resourceType/@resourceTypeGeneral" />
        <field column="resourceType" xpath="//resourceType" />
        
        <field column="ignored_alternateIdentifier_type" xpath="//alternateIdentifier/@alternateIdentifierType" />
        <field column="ignored_alternateIdentifier" xpath="//alternateIdentifier" />
        <field column="alternateIdentifier" keys="ignored_alternateIdentifier_type" values="ignored_alternateIdentifier" />
        
        <field column="ignored_relatedIdentifier_type" xpath="//relatedIdentifier/@relatedIdentifierType" />
        <field column="ignored_relatedIdentifier_relation" xpath="//relatedIdentifier/@relationType" />
        <field column="ignored_relatedIdentifier" xpath="//relatedIdentifier" />
        <field column="ignored_relatedIdentifier_relation_and_type" keys="ignored_relatedIdentifier_relation" values="ignored_relatedIdentifier_type" />
        <field column="relatedIdentifier" keys="ignored_relatedIdentifier_relation_and_type" values="ignored_relatedIdentifier" />
        
        <field column="size" xpath="//size" />
        <field column="format" xpath="//format" />
        <field column="version" xpath="//version" />
        <field column="rights" xpath="//right" />
        <field column="description" xpath="//description" />
      </entity>
    
      <entity name="media" dataSource="db"
        query="SELECT CONCAT(media_type,':',url) AS media
               FROM media AS m
               WHERE m.dataset = '${dataset.dataset_id}'
              ">
      </entity>
    </entity>
  </document>
</dataConfig>